# =============================================================================
# SĂPTĂMÂNA 19: ALGORITMI PENTRU IOT ȘI STREAM PROCESSING
# Docker Compose pentru setup complet cu MQTT broker
# =============================================================================

version: '3.8'

services:
  # ============================================================================
  # Aplicația principală - mediu de dezvoltare C
  # ============================================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: atp-week19-app
    volumes:
      - .:/workspace
    working_dir: /workspace
    stdin_open: true
    tty: true
    depends_on:
      - mosquitto
    networks:
      - iot-network
    environment:
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883

  # ============================================================================
  # Mosquitto MQTT Broker
  # ============================================================================
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: atp-week19-mqtt
    ports:
      - "1883:1883"   # MQTT standard
      - "9001:9001"   # WebSocket (opțional)
    volumes:
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
    networks:
      - iot-network
    command: mosquitto -c /mosquitto-no-auth.conf
    # Configurație simplă fără autentificare pentru dezvoltare
    entrypoint: >
      sh -c "
        echo 'listener 1883' > /mosquitto-no-auth.conf &&
        echo 'allow_anonymous true' >> /mosquitto-no-auth.conf &&
        echo 'listener 9001' >> /mosquitto-no-auth.conf &&
        echo 'protocol websockets' >> /mosquitto-no-auth.conf &&
        exec mosquitto -c /mosquitto-no-auth.conf
      "

# ============================================================================
# Volumes pentru persistență
# ============================================================================
volumes:
  mosquitto_data:
  mosquitto_log:

# ============================================================================
# Rețea pentru comunicare între containere
# ============================================================================
networks:
  iot-network:
    driver: bridge

# =============================================================================
# Instrucțiuni de utilizare:
#
# Pornire toate serviciile:
#   docker-compose up -d
#
# Conectare la container app:
#   docker-compose exec app bash
#
# Verificare MQTT broker:
#   docker-compose exec mosquitto mosquitto_sub -t '#' -v
#
# Publicare mesaj test MQTT:
#   docker-compose exec mosquitto mosquitto_pub -t 'sensors/temp' -m '22.5'
#
# Oprire servicii:
#   docker-compose down
#
# Oprire și curățare volume:
#   docker-compose down -v
#
# =============================================================================
